# 2025-07-30 ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ë¶„ë¦¬ ë°°í¬ êµ¬ì„±

GraphRAG í”„ë¡œì íŠ¸ì˜ ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë¶„ë¦¬í•˜ì—¬ ê°ê° ë‹¤ë¥¸ í”Œë«í¼ì— ë°°í¬í•˜ë„ë¡ êµ¬ì„±í•œ ë³€ê²½ì‚¬í•­ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

## ğŸ“‹ ì‘ì—… ê°œìš”

ê¸°ì¡´ì˜ í’€ìŠ¤íƒ ë°°í¬ì—ì„œ **ë°±ì—”ë“œ(Cloud Run)**ì™€ **í”„ë¡ íŠ¸ì—”ë“œ(Firebase Hosting)**ë¥¼ ë¶„ë¦¬í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ë°°í¬í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

### ğŸ¯ ëª©í‘œ
- **ë°±ì—”ë“œ**: Cloud Runì— API ì„œë²„ë§Œ ë°°í¬
- **í”„ë¡ íŠ¸ì—”ë“œ**: Firebase Hostingì— ì •ì  íŒŒì¼ë§Œ ë°°í¬
- **ë¡œì»¬ ê°œë°œ**: ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ í’€ìŠ¤íƒ ê°œë°œ ê°€ëŠ¥

## ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„

```
graphrag/
â”œâ”€â”€ main.py                 # FastAPI ë°±ì—”ë“œ ë©”ì¸ íŒŒì¼
â”œâ”€â”€ modules/                # ë°±ì—”ë“œ API ë¡œì§
â”œâ”€â”€ prompt/                 # ë°±ì—”ë“œ í”„ë¡¬í”„íŠ¸ íŒŒì¼
â”œâ”€â”€ requirements.txt        # Python ì˜ì¡´ì„±
â”œâ”€â”€ Dockerfile             # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ì„¤ì •
â”œâ”€â”€ cloudbuild.yaml        # ë°±ì—”ë“œ Cloud Run ë°°í¬
â”œâ”€â”€ public/                # í”„ë¡ íŠ¸ì—”ë“œ ì •ì  íŒŒì¼
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ style.css
â”‚   â””â”€â”€ vai.js
â”œâ”€â”€ firebase.json          # Firebase Hosting ì„¤ì •
â””â”€â”€ .github/workflows/
    â”œâ”€â”€ deploy.yml         # ë°±ì—”ë“œ ë°°í¬ ì›Œí¬í”Œë¡œìš°
    â””â”€â”€ firebase-hosting.yml # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì›Œí¬í”Œë¡œìš°
```

## ğŸ”§ ì£¼ìš” ë³€ê²½ì‚¬í•­

### 1. Dockerfile ìˆ˜ì •

**ë³€ê²½ ì „**:
```dockerfile
# ëª¨ë“  íŒŒì¼ ë³µì‚¬
COPY . .
```

**ë³€ê²½ í›„**:
```dockerfile
# ë°±ì—”ë“œ íŒŒì¼ë§Œ ì„ íƒì  ë³µì‚¬
COPY main.py .
COPY modules/ ./modules/
COPY prompt/ ./prompt/
# public/ í´ë”ëŠ” ì œì™¸ (Firebase Hostingìœ¼ë¡œ ë¶„ë¦¬)
```

### 2. main.py í™˜ê²½ë³„ ë¶„ê¸° ì²˜ë¦¬

**í•µì‹¬ ë³€ê²½ì‚¬í•­**:
```python
# í™˜ê²½ë³€ìˆ˜ë¡œ ì •ì  íŒŒì¼ ì„œë¹™ ì œì–´
import os
SERVE_STATIC = os.getenv("SERVE_STATIC", "true").lower() == "true"

if SERVE_STATIC:
    # ë¡œì»¬ ê°œë°œí™˜ê²½: ì •ì  íŒŒì¼ ì„œë¹™
    @app.get("/")
    async def serve_root():
        return FileResponse("public/index.html")
    
    app.mount("/", StaticFiles(directory="public"), name="static")
else:
    # Cloud Run ë°°í¬í™˜ê²½: APIë§Œ ì œê³µ
    @app.get("/")
    async def api_info():
        return {
            "service": "GraphRAG Chatbot API",
            "version": "2.0.0", 
            "status": "running",
            "frontend_url": "https://cheom-kdb-test1.web.app"
        }
```

### 3. Cloud Build í™˜ê²½ë³€ìˆ˜ ì¶”ê°€

**cloudbuild.yaml** ìˆ˜ì •:
```yaml
--set-env-vars=...,SERVE_STATIC=false
```

Cloud Run ë°°í¬ì‹œ ì •ì  íŒŒì¼ ì„œë¹™ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.

### 4. GitHub Actions ì›Œí¬í”Œë¡œìš° ë¶„ë¦¬

#### ë°±ì—”ë“œ ë°°í¬ (`deploy.yml`)
```yaml
name: Deploy Backend to Cloud Run

on:
  push:
    branches: [main, develop]
    paths:  # ë°±ì—”ë“œ íŒŒì¼ ë³€ê²½ì‹œë§Œ íŠ¸ë¦¬ê±°
      - 'main.py'
      - 'modules/**'
      - 'prompt/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
```

#### í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (`firebase-hosting.yml`)
```yaml
name: Firebase Hosting Deploy

on:
  push:
    branches: [main, develop]
    paths-ignore:  # ë°±ì—”ë“œ íŒŒì¼ ì œì™¸
      - 'main.py'
      - 'modules/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
```

### 5. Firebase Hosting ì„¤ì •

**firebase.json**ì€ ê¸°ì¡´ ì„¤ì •ì„ ìœ ì§€:
```json
{
  "hosting": {
    "public": "public",
    "rewrites": [
      {
        "source": "/api/**",
        "run": {
          "serviceId": "testing0724",
          "region": "asia-northeast3"
        }
      },
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
```

## ğŸš€ ë°°í¬ í”Œë¡œìš°

### ë°±ì—”ë“œ ë°°í¬ (Cloud Run)

1. **íŠ¸ë¦¬ê±°**: `main.py`, `modules/`, `prompt/`, `requirements.txt`, `Dockerfile`, `cloudbuild.yaml` íŒŒì¼ ë³€ê²½
2. **ê³¼ì •**:
   - Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë°±ì—”ë“œ íŒŒì¼ë§Œ í¬í•¨)
   - Artifact Registryì— í‘¸ì‹œ
   - Cloud Runì— ë°°í¬ (`SERVE_STATIC=false`)
   - í—¬ìŠ¤ ì²´í¬ ë° íŠ¸ë˜í”½ ì „í™˜

### í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (Firebase Hosting)

1. **íŠ¸ë¦¬ê±°**: `public/` í´ë” ë˜ëŠ” `firebase.json` íŒŒì¼ ë³€ê²½
2. **ê³¼ì •**:
   - ì •ì  íŒŒì¼ ë¹Œë“œ/ê²€ì¦
   - Firebase Hostingì— ë°°í¬
   - í™˜ê²½ë³„ ì±„ë„ ë¶„ë¦¬:
     - `develop` â†’ staging ì±„ë„
     - `main` â†’ live ì±„ë„

## ğŸ¯ í™˜ê²½ë³„ êµ¬ì„±

### ë¡œì»¬ ê°œë°œ í™˜ê²½
```bash
# í’€ìŠ¤íƒ ê°œë°œ ê°€ëŠ¥ (ê¸°ë³¸ê°’)
python main.py
# ë˜ëŠ”
SERVE_STATIC=true python main.py
```
- ë°±ì—”ë“œ API + í”„ë¡ íŠ¸ì—”ë“œ ì •ì  íŒŒì¼ ëª¨ë‘ ì„œë¹™
- `http://localhost:8000`ì—ì„œ ì›¹ í™”ë©´ í™•ì¸ ê°€ëŠ¥

### ìŠ¤í…Œì´ì§• í™˜ê²½ (develop ë¸Œëœì¹˜)
- **ë°±ì—”ë“œ**: Cloud Run `testing0724` ì„œë¹„ìŠ¤
- **í”„ë¡ íŠ¸ì—”ë“œ**: `https://staging--cheom-kdb-test1.web.app`
- API ìš”ì²­ì€ Firebase â†’ Cloud Runìœ¼ë¡œ í”„ë¡ì‹œ

### í”„ë¡œë•ì…˜ í™˜ê²½ (main ë¸Œëœì¹˜)
- **ë°±ì—”ë“œ**: Cloud Run `graphrag-api` ì„œë¹„ìŠ¤ (ì˜ˆì •)
- **í”„ë¡ íŠ¸ì—”ë“œ**: `https://cheom-kdb-test1.web.app`
- API ìš”ì²­ì€ Firebase â†’ Cloud Runìœ¼ë¡œ í”„ë¡ì‹œ

## ğŸ“Š ë°°í¬ íŠ¸ë¦¬ê±° ë§¤íŠ¸ë¦­ìŠ¤

| ë³€ê²½ëœ íŒŒì¼ | ë°±ì—”ë“œ ë°°í¬ | í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ |
|-------------|-------------|-----------------|
| `main.py` | âœ… | âŒ |
| `modules/**` | âœ… | âŒ |
| `public/**` | âŒ | âœ… |
| `firebase.json` | âŒ | âœ… |
| `README.md` | âŒ | âŒ |
| ë°±ì—”ë“œ+í”„ë¡ íŠ¸ì—”ë“œ ë™ì‹œ ìˆ˜ì • | âœ… | âœ… |

## ğŸ” í…ŒìŠ¤íŠ¸ ë°©ë²•

### ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
```bash
# main.py ìˆ˜ì • í›„ ì»¤ë°‹/í‘¸ì‹œ
git add main.py
git commit -m "Test: ë°±ì—”ë“œ ë°°í¬ í…ŒìŠ¤íŠ¸"
git push
```
â†’ "Deploy Backend to Cloud Run" ì›Œí¬í”Œë¡œìš°ë§Œ ì‹¤í–‰

### í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
```bash
# public/index.html ìˆ˜ì • í›„ ì»¤ë°‹/í‘¸ì‹œ
git add public/
git commit -m "Test: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ í…ŒìŠ¤íŠ¸"
git push
```
â†’ "Firebase Hosting Deploy" ì›Œí¬í”Œë¡œìš°ë§Œ ì‹¤í–‰

### í†µí•© í…ŒìŠ¤íŠ¸
```bash
# ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ëª¨ë‘ ìˆ˜ì • í›„ ì»¤ë°‹/í‘¸ì‹œ
git add .
git commit -m "Test: ë¶„ë¦¬ ë°°í¬ í†µí•© í…ŒìŠ¤íŠ¸"
git push
```
â†’ ë‘ ì›Œí¬í”Œë¡œìš° ëª¨ë‘ ì‹¤í–‰

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ì •ì  íŒŒì¼ ì°¸ì¡°**: Cloud Runì—ì„œëŠ” `public/` í´ë”ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë°±ì—”ë“œ ì½”ë“œì—ì„œ ì •ì  íŒŒì¼ì„ ì§ì ‘ ì°¸ì¡°í•˜ë©´ ì•ˆë©ë‹ˆë‹¤.

2. **CORS ì„¤ì •**: í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œê°€ ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ CORS ì„¤ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

3. **API ê²½ë¡œ**: Firebase Hostingì˜ rewrite ê·œì¹™ì— ë”°ë¼ `/api/**` ê²½ë¡œë§Œ ë°±ì—”ë“œë¡œ ë¼ìš°íŒ…ë©ë‹ˆë‹¤.

4. **í™˜ê²½ë³€ìˆ˜**: ë¡œì»¬ ê°œë°œì‹œì—ëŠ” `SERVE_STATIC=true`(ê¸°ë³¸ê°’), ë°°í¬ì‹œì—ëŠ” `SERVE_STATIC=false`ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.

## ğŸ‰ ì˜ˆìƒ íš¨ê³¼

### ì¥ì 
- **ë…ë¦½ì  ë°°í¬**: ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ë°°í¬ ê°€ëŠ¥
- **ì„±ëŠ¥ ìµœì í™”**: ì •ì  íŒŒì¼ì€ CDN(Firebase Hosting), APIëŠ” Cloud Runìœ¼ë¡œ ìµœì í™”
- **ë¹„ìš© ì ˆì•½**: ì •ì  íŒŒì¼ ì„œë¹™ ë¹„ìš© ì ˆì•½
- **í™•ì¥ì„±**: ê°ê° ë‹¤ë¥¸ ìŠ¤ì¼€ì¼ë§ ì •ì±… ì ìš© ê°€ëŠ¥

### ê°œë°œ íš¨ìœ¨ì„±
- **ì„ íƒì  ë°°í¬**: ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë°°í¬ë˜ì–´ ì‹œê°„ ë‹¨ì¶•
- **ê°œë°œ í™˜ê²½ ìœ ì§€**: ë¡œì»¬ì—ì„œëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•œ ê°œë°œ ê²½í—˜
- **í™˜ê²½ ë¶„ë¦¬**: stagingê³¼ production í™˜ê²½ ëª…í™•íˆ ë¶„ë¦¬

## ğŸ“ í–¥í›„ ê°œì„ ì‚¬í•­

1. **í™˜ê²½ë³„ ì„œë¹„ìŠ¤ëª… ë¶„ë¦¬**: í˜„ì¬ staging/production ëª¨ë‘ ê°™ì€ Cloud Run ì„œë¹„ìŠ¤ ì‚¬ìš©
2. **ë³´ì•ˆ ìŠ¤ìº” í™œì„±í™”**: í•„ìš”ì‹œ cloudbuild.yamlì˜ ë³´ì•ˆ ìŠ¤ìº” ë‹¨ê³„ í™œì„±í™”
3. **ëª¨ë‹ˆí„°ë§ ê°•í™”**: ê° í™˜ê²½ë³„ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì •
4. **ì„±ëŠ¥ ìµœì í™”**: ë°°í¬ ì†ë„ ë° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ìµœì í™”

---

**ì‘ì—… ì™„ë£Œì¼**: 2025-07-30  
**ë‹´ë‹¹ì**: Claude Code  
**ìƒíƒœ**: ì™„ë£Œ âœ…