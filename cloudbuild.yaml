steps:
# 1. Docker ì´ë¯¸ì§€ ë¹Œë“œ
- name: 'gcr.io/cloud-builders/docker'
  id: build-image
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 1. Docker ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
      docker build -t "${_ARTIFACT_REGISTRY}/documentation-467305/documentation-467305-graphrag-repo/documentation-467305-graphrag-api:${SHORT_SHA}" -t "${_ARTIFACT_REGISTRY}/documentation-467305/documentation-467305-graphrag-repo/documentation-467305-graphrag-api:latest" .
      echo "âœ… 1. Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

# 2. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
- name: 'gcr.io/cloud-builders/docker'
  id: push-image
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 2. ì´ë¯¸ì§€ë¥¼ Artifact Registryì— í‘¸ì‹œí•©ë‹ˆë‹¤..."
      docker push "${_ARTIFACT_REGISTRY}/documentation-467305/documentation-467305-graphrag-repo/documentation-467305-graphrag-api" --all-tags
      echo "âœ… 2. ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
  waitFor:
    - build-image

# 3. Cloud Run ì„œë¹„ìŠ¤ ë°°í¬
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: deploy-service
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 3. Cloud Run ì„œë¹„ìŠ¤ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
      gcloud run deploy "documentation-467305-graphrag-api" \
        --image="${_ARTIFACT_REGISTRY}/documentation-467305/documentation-467305-graphrag-repo/documentation-467305-graphrag-api:${SHORT_SHA}" \
        --region="asia-northeast3" \
        --platform=managed \
        --allow-unauthenticated \
        --service-account="graphrag-service@documentation-467305.iam.gserviceaccount.com" \
        --min-instances="${_MIN_INSTANCES}" \
        --max-instances="${_MAX_INSTANCES}" \
        --cpu="${_CPU}" \
        --memory="${_MEMORY}" \
        --timeout="${_TIMEOUT}" \
        --set-env-vars="PROJECT_ID=documentation-467305,LOCATION_ID=asia-northeast3,MODEL_ID=${_MODEL_ID},DATASTORE_ID=documentation-467305-graphrag-datastore,DATASTORE_LOCATION=global,DISCOVERY_ENGINE_ID=documentation-467305-graphrag-engine,DISCOVERY_LOCATION=global,DISCOVERY_COLLECTION=default_collection,DISCOVERY_SERVING_CONFIG=default_config,SYSTEM_PROMPT_PATH=prompt/prompt.txt,USE_SECRET_MANAGER=True,SERVE_STATIC=false"
      echo "âœ… 3. Cloud Run ì„œë¹„ìŠ¤ ë°°í¬ ì™„ë£Œ"
  waitFor:
    - push-image

# 4. í—¬ìŠ¤ ì²´í¬
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: health-check
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 4. ë°°í¬ëœ ì„œë¹„ìŠ¤ì˜ í—¬ìŠ¤ ì²´í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
      SERVICE_URL=$$(gcloud run services describe documentation-467305-graphrag-api --region=asia-northeast3 --format="value(status.url)")
      if [ -z "$$SERVICE_URL" ]; then
        echo "âŒ ì„œë¹„ìŠ¤ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
      fi
      echo "ì„œë¹„ìŠ¤ URL: $$SERVICE_URL"
      for i in {1..12}; do
        echo "... í—¬ìŠ¤ ì²´í¬ ì‹œë„ $$i/12 ..."
        STATUS_CODE=$$(curl -o /dev/null -s -w "%{\http_code}" --connect-timeout 5 --max-time 10 "$$SERVICE_URL/api/health")
        if [ "$$STATUS_CODE" -eq 200 ]; then
          echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ! (ìƒíƒœ ì½”ë“œ: $$STATUS_CODE)"
          exit 0
        else
          echo "... ì‹¤íŒ¨ (ìƒíƒœ ì½”ë“œ: $$STATUS_CODE)"
        fi
        if [ $$i -lt 12 ]; then
          echo "... 10ì´ˆ í›„ ì¬ì‹œë„ ..."
          sleep 10
        fi
      done
      echo "âŒ ìµœì¢… í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨."
      exit 1
  waitFor:
    - deploy-service

# ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´
images:
  - '${_ARTIFACT_REGISTRY}/documentation-467305/documentation-467305-graphrag-repo/documentation-467305-graphrag-api:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/documentation-467305/documentation-467305-graphrag-repo/documentation-467305-graphrag-api:latest'

# ë¹Œë“œ ì˜µì…˜
options:
  logging: CLOUD_LOGGING_ONLY

# ì„œë¹„ìŠ¤ ê³„ì •
serviceAccount: 'projects/documentation-467305/serviceAccounts/graphrag-service@documentation-467305.iam.gserviceaccount.com'

# ì¹˜í™˜ ë³€ìˆ˜ ê¸°ë³¸ê°’
substitutions:
  _PROJECT_ID: documentation-467305
  _REGION: asia-northeast3
  _LOCATION_ID: asia-northeast3
  _SERVICE_NAME: documentation-467305-graphrag-api
  _REPO_NAME: documentation-467305-graphrag-repo
  _SERVICE_ACCOUNT: graphrag-service@documentation-467305.iam.gserviceaccount.com
  _ARTIFACT_REGISTRY: asia-northeast3-docker.pkg.dev
  _DATASTORE_ID: documentation-467305-graphrag-datastore
  _DATASTORE_LOCATION: global
  _DISCOVERY_ENGINE_ID: documentation-467305-graphrag-engine
  _DISCOVERY_LOCATION: global
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '10'
  _CPU: '1'
  _MEMORY: 2Gi
  _TIMEOUT: 300s
  _MODEL_ID: gemini-pro
