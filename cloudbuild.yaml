steps:
# 1. Docker ì´ë¯¸ì§€ ë¹Œë“œ
- name: 'gcr.io/cloud-builders/docker'
  id: build-image
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 1. Docker ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
      docker build -t "${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}" -t "${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest" .
      echo "âœ… 1. Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

# 2. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
- name: 'gcr.io/cloud-builders/docker'
  id: push-image
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 2. ì´ë¯¸ì§€ë¥¼ Artifact Registryì— í‘¸ì‹œí•©ë‹ˆë‹¤..."
      docker push "${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}" --all-tags
      echo "âœ… 2. ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
  waitFor:
    - build-image

# 3. ë¸”ë£¨ê·¸ë¦° ë°°í¬: ìƒˆ ë²„ì „ì„ ë³„ë„ ì„œë¹„ìŠ¤ë¡œ ë°°í¬ (íŠ¸ë˜í”½ 0%)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: deploy-green-service
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 3. ë¸”ë£¨ê·¸ë¦° ë°°í¬ - Green ë²„ì „ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
      GREEN_SERVICE_NAME="${_SERVICE_NAME}-green-${SHORT_SHA}"
      echo "Green ì„œë¹„ìŠ¤ëª…: $$GREEN_SERVICE_NAME"
      
      gcloud run deploy "$$GREEN_SERVICE_NAME" \
        --image="${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}" \
        --region="${_REGION}" \
        --platform=managed \
        --no-allow-unauthenticated \
        --service-account="${_SERVICE_ACCOUNT}" \
        --min-instances="${_MIN_INSTANCES}" \
        --max-instances="${_MAX_INSTANCES}" \
        --cpu="${_CPU}" \
        --memory="${_MEMORY}" \
        --timeout="${_TIMEOUT}" \
        --set-env-vars="PROJECT_ID=${_PROJECT_ID},LOCATION_ID=${_LOCATION_ID},MODEL_ID=${_MODEL_ID},DATASTORE_ID=${_DATASTORE_ID},DATASTORE_LOCATION=${_DATASTORE_LOCATION},DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},DISCOVERY_LOCATION=${_DISCOVERY_LOCATION},DISCOVERY_COLLECTION=default_collection,DISCOVERY_SERVING_CONFIG=default_config,SYSTEM_PROMPT_PATH=prompt/prompt.txt,USE_SECRET_MANAGER=True,SERVE_STATIC=false" \
        --tag="green-$$SHORT_SHA"
      
      echo "âœ… 3. Green ë²„ì „ ë°°í¬ ì™„ë£Œ (íŠ¸ë˜í”½ 0%)"
  waitFor:
    - push-image

# 4. Green ë²„ì „ í—¬ìŠ¤ ì²´í¬
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: health-check-green
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 4. Green ë²„ì „ í—¬ìŠ¤ ì²´í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
      GREEN_SERVICE_NAME="${_SERVICE_NAME}-green-${SHORT_SHA}"
      
      # Green ë²„ì „ì˜ ì§ì ‘ URL ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ê¸°ë°˜)
      GREEN_URL=$$(gcloud run services describe "$$GREEN_SERVICE_NAME" --region=${_REGION} --format="value(status.traffic[0].url)")
      if [ -z "$$GREEN_URL" ]; then
        echo "âŒ Green ì„œë¹„ìŠ¤ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
      fi
      
      echo "Green ì„œë¹„ìŠ¤ URL: $$GREEN_URL"
      
      # í—¬ìŠ¤ ì²´í¬ ìˆ˜í–‰
      for i in $$(seq 1 12); do
        echo "... Green ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì‹œë„ $$i/12 ..."
        STATUS_CODE=$$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 5 --max-time 10 "$$GREEN_URL/api/health")
        if [ "$$STATUS_CODE" = "200" ]; then
          echo "âœ… Green ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ! (ìƒíƒœ ì½”ë“œ: $$STATUS_CODE)"
          break
        else
          echo "... ì‹¤íŒ¨ (ìƒíƒœ ì½”ë“œ: $$STATUS_CODE)"
        fi
        if [ $$i -lt 12 ]; then
          echo "... 10ì´ˆ í›„ ì¬ì‹œë„ ..."
          sleep 10
        else
          echo "âŒ Green ë²„ì „ í—¬ìŠ¤ ì²´í¬ ìµœì¢… ì‹¤íŒ¨."
          exit 1
        fi
      done
  waitFor:
    - deploy-green-service

# 5. íŠ¸ë˜í”½ ì „í™˜ (Blue â†’ Green)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: switch-traffic
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 5. íŠ¸ë˜í”½ ì „í™˜ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
      GREEN_SERVICE_NAME="${_SERVICE_NAME}-green-${SHORT_SHA}"
      
      # ê¸°ì¡´ ë©”ì¸ ì„œë¹„ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
      if gcloud run services describe "${_SERVICE_NAME}" --region=${_REGION} >/dev/null 2>&1; then
        echo "ê¸°ì¡´ Blue ì„œë¹„ìŠ¤ ë°œê²¬: ${_SERVICE_NAME}"
        BLUE_EXISTS="true"
      else
        echo "ê¸°ì¡´ ì„œë¹„ìŠ¤ ì—†ìŒ - ì²« ë°°í¬ì…ë‹ˆë‹¤."
        BLUE_EXISTS="false"
      fi
      
      # Greenì„ ë©”ì¸ ì„œë¹„ìŠ¤ë¡œ ìŠ¹ê²©
      echo "Green ì„œë¹„ìŠ¤ë¥¼ ë©”ì¸ ì„œë¹„ìŠ¤ë¡œ ìŠ¹ê²© ì¤‘..."
      gcloud run services replace-traffic "${_SERVICE_NAME}" \
        --to-revisions=LATEST=100 \
        --region=${_REGION} || {
        # ë©”ì¸ ì„œë¹„ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        echo "ë©”ì¸ ì„œë¹„ìŠ¤ ìƒì„± ì¤‘..."
        gcloud run deploy "${_SERVICE_NAME}" \
          --image="${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}" \
          --region="${_REGION}" \
          --platform=managed \
          --allow-unauthenticated \
          --service-account="${_SERVICE_ACCOUNT}" \
          --min-instances="${_MIN_INSTANCES}" \
          --max-instances="${_MAX_INSTANCES}" \
          --cpu="${_CPU}" \
          --memory="${_MEMORY}" \
          --timeout="${_TIMEOUT}" \
          --set-env-vars="PROJECT_ID=${_PROJECT_ID},LOCATION_ID=${_LOCATION_ID},MODEL_ID=${_MODEL_ID},DATASTORE_ID=${_DATASTORE_ID},DATASTORE_LOCATION=${_DATASTORE_LOCATION},DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},DISCOVERY_LOCATION=${_DISCOVERY_LOCATION},DISCOVERY_COLLECTION=default_collection,DISCOVERY_SERVING_CONFIG=default_config,SYSTEM_PROMPT_PATH=prompt/prompt.txt,USE_SECRET_MANAGER=True,SERVE_STATIC=false"
      }
      
      # ìµœì¢… í—¬ìŠ¤ ì²´í¬ (ë©”ì¸ ì„œë¹„ìŠ¤)
      echo "ë©”ì¸ ì„œë¹„ìŠ¤ ìµœì¢… í—¬ìŠ¤ ì²´í¬..."
      MAIN_URL=$$(gcloud run services describe "${_SERVICE_NAME}" --region=${_REGION} --format="value(status.url)")
      STATUS_CODE=$$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 5 --max-time 10 "$$MAIN_URL/api/health")
      
      if [ "$$STATUS_CODE" = "200" ]; then
        echo "âœ… íŠ¸ë˜í”½ ì „í™˜ ì„±ê³µ! ë©”ì¸ ì„œë¹„ìŠ¤ URL: $$MAIN_URL"
      else
        echo "âŒ ë©”ì¸ ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
        exit 1
      fi
  waitFor:
    - health-check-green

# 6. ì •ë¦¬ ì‘ì—… (Green ì„œë¹„ìŠ¤ ì‚­ì œ)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: cleanup-green
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ 6. Green ì„œë¹„ìŠ¤ ì •ë¦¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
      GREEN_SERVICE_NAME="${_SERVICE_NAME}-green-${SHORT_SHA}"
      
      # Green ì„œë¹„ìŠ¤ ì‚­ì œ (ë©”ì¸ ì„œë¹„ìŠ¤ë¡œ ìŠ¹ê²©í–ˆìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”)
      echo "ì„ì‹œ Green ì„œë¹„ìŠ¤ ì‚­ì œ ì¤‘: $$GREEN_SERVICE_NAME"
      gcloud run services delete "$$GREEN_SERVICE_NAME" --region=${_REGION} --quiet || echo "Green ì„œë¹„ìŠ¤ ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)"
      
      echo "âœ… ì •ë¦¬ ì‘ì—… ì™„ë£Œ"
  waitFor:
    - switch-traffic

# ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´
images:
  - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'

# ë¹Œë“œ ì˜µì…˜
options:
  logging: CLOUD_LOGGING_ONLY

# ì„œë¹„ìŠ¤ ê³„ì •
serviceAccount: 'projects/${_PROJECT_ID}/serviceAccounts/${_SERVICE_ACCOUNT}'

# ì¹˜í™˜ ë³€ìˆ˜ ê¸°ë³¸ê°’
substitutions:
  _PROJECT_ID: documentation-467305
  _REGION: asia-northeast3
  _LOCATION_ID: asia-northeast3
  _SERVICE_NAME: documentation-467305-graphrag-api
  _REPO_NAME: documentation-467305-graphrag-repo
  _SERVICE_ACCOUNT: graphrag-service@documentation-467305.iam.gserviceaccount.com
  _ARTIFACT_REGISTRY: asia-northeast3-docker.pkg.dev
  _DATASTORE_ID: documentation-467305-graphrag-datastore
  _DATASTORE_LOCATION: global
  _DISCOVERY_ENGINE_ID: documentation-467305-graphrag-engine
  _DISCOVERY_LOCATION: global
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '10'
  _CPU: '1'
  _MEMORY: 2Gi
  _TIMEOUT: 300s
  _MODEL_ID: gemini-pro
