# Cloud Build ì„¤ì • íŒŒì¼ - GraphRAG ì±—ë´‡ API ì§€ì†ì  ë°°í¬
# Trigger: GitHub ì—°ë™ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ ìë™ ë¹Œë“œ/ë°°í¬

substitutions:
  _PROJECT_ID: cheom-kdb-test1
  _REGION: asia-northeast3
  _REPO_NAME: trialanderror0724
  _SERVICE_NAME: testing0724
  _SERVICE_ACCOUNT: 580360941782-compute@developer.gserviceaccount.com
  _ARTIFACT_REGISTRY: asia-northeast3-docker.pkg.dev
  _MIN_INSTANCES: '1'
  _MAX_INSTANCES: '20'
  _CPU: '2'
  _MEMORY: '4Gi'
  _TIMEOUT: '900s'
  _DISCOVERY_ENGINE_ID: test_1753406039510

steps:
  # 1. ë¹Œë“œ ì‚¬ì „ ê²€ì¦
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” ë¹Œë“œ í™˜ê²½ ê²€ì¦ ì¤‘..."
        echo "í”„ë¡œì íŠ¸ ID: ${_PROJECT_ID}"
        echo "ì„œë¹„ìŠ¤ëª…: ${_SERVICE_NAME}"
        echo "ë¦¬ì „: ${_REGION}"
        echo "ì»¤ë°‹ SHA: ${SHORT_SHA}"
        echo "ë¸Œëœì¹˜: ${BRANCH_NAME}"
        
        # Dockerfile ì¡´ì¬ í™•ì¸
        if [ ! -f "Dockerfile" ]; then
          echo "âŒ Dockerfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # requirements.txt ê²€ì¦
        if [ ! -f "requirements.txt" ]; then
          echo "âŒ requirements.txtê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "âœ… ë¹Œë“œ ì‚¬ì „ ê²€ì¦ ì™„ë£Œ"
    id: 'pre-build-validation'

  # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '-t'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
      - '--cache-from'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
      - '.'
    id: 'build-image'
    waitFor: ['pre-build-validation']

  # 3. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}'
    id: 'push-image'
    waitFor: ['build-image']

  # 4. ë³´ì•ˆ ìŠ¤ìº” ê±´ë„ˆëœ€ (GitHub Actionsì˜ Trivy ìŠ¤ìº” ì‚¬ìš©)

  # 5. Cloud Run ë°°í¬ (Blue-Green ë°°í¬)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Cloud Run ì„œë¹„ìŠ¤ ë°°í¬ ì‹œì‘ (Blue-Green ë°©ì‹)..."
        
        # ê¶Œí•œ ë° ì„¤ì • í™•ì¸
        echo "ğŸ” ê¶Œí•œ ë° ì„¤ì • í™•ì¸..."
        echo "í”„ë¡œì íŠ¸ ID: ${_PROJECT_ID}"
        echo "ì„œë¹„ìŠ¤ ê³„ì •: ${_SERVICE_ACCOUNT}"
        echo "ì´ë¯¸ì§€: ${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}"
        
        # Cloud Run API í™œì„±í™” í™•ì¸
        gcloud services enable run.googleapis.com --project=${_PROJECT_ID} || echo "âš ï¸ Cloud Run API ì´ë¯¸ í™œì„±í™”ë¨"
        
        # --no-traffic í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ë¦¬ë¹„ì „ì„ ë°°í¬í•˜ê³  'candidate' íƒœê·¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        # ì´ ë¦¬ë¹„ì „ì€ ì²˜ìŒì—ëŠ” í”„ë¡œë•ì…˜ íŠ¸ë˜í”½ì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.
        # ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì´ ëª…ë ¹ì´ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        
        # ì„œë¹„ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if gcloud run services describe ${_SERVICE_NAME} --region=${_REGION} --quiet > /dev/null 2>&1; then
          echo "âœ… ê¸°ì¡´ ì„œë¹„ìŠ¤ ë°œê²¬, ì—…ë°ì´íŠ¸ ì§„í–‰"
          gcloud run deploy ${_SERVICE_NAME} \
            --image=${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA} \
            --region=${_REGION} \
            --platform=managed \
            --service-account=${_SERVICE_ACCOUNT} \
            --min-instances=${_MIN_INSTANCES} \
            --max-instances=${_MAX_INSTANCES} \
            --cpu=${_CPU} \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --concurrency=80 \
            --no-traffic \
            --tag=candidate \
            --set-env-vars=PROJECT_ID=${_PROJECT_ID},DISCOVERY_LOCATION=global,DISCOVERY_COLLECTION=default_collection,DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},DISCOVERY_SERVING_CONFIG=default_config,SYSTEM_PROMPT_PATH=prompt/prompt.txt
        else
          echo "ğŸ†• ìƒˆ ì„œë¹„ìŠ¤ ìƒì„±"
          gcloud run deploy ${_SERVICE_NAME} \
            --image=${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA} \
            --region=${_REGION} \
            --platform=managed \
            --allow-unauthenticated \
            --service-account=${_SERVICE_ACCOUNT} \
            --min-instances=${_MIN_INSTANCES} \
            --max-instances=${_MAX_INSTANCES} \
            --cpu=${_CPU} \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --concurrency=80 \
            --tag=candidate \
            --set-env-vars=PROJECT_ID=${_PROJECT_ID},DISCOVERY_LOCATION=global,DISCOVERY_COLLECTION=default_collection,DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},DISCOVERY_SERVING_CONFIG=default_config,SYSTEM_PROMPT_PATH=prompt/prompt.txt
        fi
        
        echo "âœ… ìƒˆ ë¦¬ë¹„ì „ì´ 'candidate' íƒœê·¸ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
    id: 'deploy-candidate'
    waitFor: ['push-image']

  # 6. í—¬ìŠ¤ ì²´í¬ ë° ê²€ì¦
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
        
        # í›„ë³´ ë²„ì „ URL ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ë°©ì‹)
        echo "ì„œë¹„ìŠ¤ëª…: ${_SERVICE_NAME}"
        echo "ë¦¬ì „: ${_REGION}"
        
        # íŠ¸ë˜í”½ ìƒíƒœ ì „ì²´ í™•ì¸
        echo "ğŸ” í˜„ì¬ íŠ¸ë˜í”½ ìƒíƒœ:"
        gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="table(status.traffic[].tag,status.traffic[].url,status.traffic[].percent)"
        
        # candidate íƒœê·¸ URL ì¶”ì¶œ (ìˆ˜ì •ëœ ë°©ë²•)
        HEALTH_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="value(status.traffic[?tag='candidate'].url)")
        
        # ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œë„ ì‹œë„ (python ì‚¬ìš©)
        if [ -z "$$HEALTH_URL" ]; then
          echo "ğŸ”„ Pythonì„ ì‚¬ìš©í•œ candidate URL ê²€ìƒ‰..."
          HEALTH_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
            --region=${_REGION} \
            --format="json" | python3 -c "import sys, json; data = json.load(sys.stdin); [print(traffic.get('url', '')) for traffic in data.get('status', {}).get('traffic', []) if traffic.get('tag') == 'candidate'][:1]")
        fi
        
        # ê·¸ë˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„œë¹„ìŠ¤ URL ì‚¬ìš©
        if [ -z "$$HEALTH_URL" ] || [ "$$HEALTH_URL" = "null" ]; then
          echo "âš ï¸ candidate íƒœê·¸ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„œë¹„ìŠ¤ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          HEALTH_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
            --region=${_REGION} \
            --format="value(status.url)")
        fi
        
        if [ -z "$$HEALTH_URL" ]; then
          echo "âŒ ì„œë¹„ìŠ¤ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "í—¬ìŠ¤ ì²´í¬ URL: $$HEALTH_URL"
        
        # í—¬ìŠ¤ ì²´í¬ (ìµœëŒ€ 5íšŒ ì¬ì‹œë„)
        for i in {1..5}; do
          echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $$i/5..."
          
          if curl -f -s --max-time 10 "$$HEALTH_URL/api/health" > /dev/null; then
            echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
            
            # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸
            echo "ğŸ§ª API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
            RESPONSE=$$(curl -s --max-time 60 -X POST "$$HEALTH_URL/api/generate" \
              -d "userPrompt=í…ŒìŠ¤íŠ¸" \
              -d "conversationHistory=[]")
            
            if echo "$$RESPONSE" | grep -q "answer\|summary_answer"; then
              echo "âœ… API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
              echo "URL=$$HEALTH_URL" > /workspace/candidate_url.txt
              exit 0
            else
              echo "âš ï¸ API ì‘ë‹µì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤: $$RESPONSE"
            fi
          else
            echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $$i/5)"
          fi
          
          if [ $$i -lt 5 ]; then
            echo "30ì´ˆ í›„ ì¬ì‹œë„..."
            sleep 30
          fi
        done
        
        echo "âŒ í—¬ìŠ¤ ì²´í¬ ìµœì¢… ì‹¤íŒ¨"
        exit 1
    id: 'health-check'
    waitFor: ['deploy-candidate']

  # 7. íŠ¸ë˜í”½ ì „í™˜ (Blue-Green ë°°í¬ ì™„ë£Œ)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ í”„ë¡œë•ì…˜ íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘..."
        
        # ëª¨ë“  íŠ¸ë˜í”½ì„ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜
        gcloud run services update-traffic ${_SERVICE_NAME} \
          --to-tags=candidate=100 \
          --region=${_REGION}
        
        echo "âœ… íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
        
        # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        echo "ì„œë¹„ìŠ¤ URL: https://${_SERVICE_NAME}-580360941782.${_REGION}.run.app"
        echo "ì»¤ë°‹ SHA: ${SHORT_SHA}"
        echo "ë°°í¬ ì‹œê°„: $(date)"
    id: 'traffic-switch'
    waitFor: ['health-check']

  # 8. ì´ì „ ë²„ì „ ì •ë¦¬ (ì„ íƒì‚¬í•­)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§¹ ì´ì „ ë²„ì „ ì •ë¦¬ ì¤‘..."
        
        # íƒœê·¸ ì œê±° (candidate íƒœê·¸ë¥¼ ì œê±°í•˜ì—¬ ì •ë¦¬)
        gcloud run services update-traffic ${_SERVICE_NAME} \
          --remove-tags=candidate \
          --region=${_REGION} || echo "âš ï¸ íƒœê·¸ ì œê±° ì‹¤íŒ¨ (ë¬´ì‹œ)"
        
        # ì˜¤ë˜ëœ ë¦¬ë¹„ì „ ì •ë¦¬ (ìµœê·¼ 5ê°œë§Œ ìœ ì§€)
        gcloud run revisions list \
          --service=${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="value(metadata.name)" \
          --limit=100 \
          | tail -n +6 \
          | xargs -I {} gcloud run revisions delete {} \
            --region=${_REGION} \
            --quiet || echo "âš ï¸ ì´ì „ ë¦¬ë¹„ì „ ì •ë¦¬ ì‹¤íŒ¨ (ë¬´ì‹œ)"
        
        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
    id: 'cleanup'
    waitFor: ['traffic-switch']

# ë¹Œë“œ ì˜µì…˜
options:
  # ë¹Œë“œ ë¡œê·¸ë¥¼ Cloud Loggingì—ë§Œ ì €ì¥
  logging: CLOUD_LOGGING_ONLY
  
  # ë¹Œë“œ ë¨¸ì‹  ìŠ¤í™ (ë” ë¹ ë¥¸ ë¹Œë“œë¥¼ ìœ„í•´)
  machineType: 'E2_HIGHCPU_8'
  
# ì„œë¹„ìŠ¤ ê³„ì • (í•„ìš”í•œ ê¶Œí•œ: Cloud Run Admin, Artifact Registry Writer, Security Scanner)
serviceAccount: 'projects/${_PROJECT_ID}/serviceAccounts/${_SERVICE_ACCOUNT}'

# ì´ë¯¸ì§€ ì €ì¥ì†Œì—ì„œ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ìë™ ì‚­ì œ (ì„ íƒì‚¬í•­)
images:
  - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'