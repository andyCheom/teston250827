# Cloud Build ì„¤ì • íŒŒì¼ - GraphRAG ì±—ë´‡ API ì§€ì†ì  ë°°í¬
# Trigger: GitHub ì—°ë™ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ ìë™ ë¹Œë“œ/ë°°í¬

substitutions:
  _PROJECT_ID: cheom-kdb-test1
  _REGION: asia-northeast3
  _REPO_NAME: trialanderror0724
  _SERVICE_NAME: testing0724
  _SERVICE_ACCOUNT: 580360941782-compute@developer.gserviceaccount.com
  _ARTIFACT_REGISTRY: asia-northeast3-docker.pkg.dev
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '20'
  _CPU: '1'
  _MEMORY: '2Gi'
  _TIMEOUT: '900s'

steps:
  # 1. ë¹Œë“œ ì‚¬ì „ ê²€ì¦
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” ë¹Œë“œ í™˜ê²½ ê²€ì¦ ì¤‘..."
        echo "í”„ë¡œì íŠ¸ ID: ${_PROJECT_ID}"
        echo "ì„œë¹„ìŠ¤ëª…: ${_SERVICE_NAME}"
        echo "ë¦¬ì „: ${_REGION}"
        echo "ì»¤ë°‹ SHA: ${SHORT_SHA}"
        echo "ë¸Œëœì¹˜: ${BRANCH_NAME}"
        
        # Dockerfile ì¡´ì¬ í™•ì¸
        if [ ! -f "Dockerfile" ]; then
          echo "âŒ Dockerfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # requirements.txt ê²€ì¦
        if [ ! -f "requirements.txt" ]; then
          echo "âŒ requirements.txtê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "âœ… ë¹Œë“œ ì‚¬ì „ ê²€ì¦ ì™„ë£Œ"
    id: 'pre-build-validation'

  # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '-t'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
      - '--cache-from'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
      - '.'
    id: 'build-image'
    waitFor: ['pre-build-validation']

  # 3. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}'
    id: 'push-image'
    waitFor: ['build-image']

  # 4. ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” (ì„ íƒì‚¬í•­)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”’ ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘..."
        gcloud artifacts docker images scan ${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA} \
          --remote --format="value(response.scan)" || echo "âš ï¸ ë³´ì•ˆ ìŠ¤ìº” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        echo "âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
    id: 'security-scan'
    waitFor: ['push-image']

  # 5. Cloud Run ë°°í¬ (ì„œë¹„ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ë°°í¬)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Cloud Run ì„œë¹„ìŠ¤ ë°°í¬ ì‹œì‘..."
        
        # ì„œë¹„ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if gcloud run services describe ${_SERVICE_NAME} --region=${_REGION} --quiet 2>/dev/null; then
          echo "âœ… ê¸°ì¡´ ì„œë¹„ìŠ¤ ë°œê²¬ - Blue-Green ë°°í¬ ì§„í–‰"
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ê°€ ìˆëŠ” ê²½ìš°: --no-trafficê³¼ --tag ì‚¬ìš©
          gcloud run deploy ${_SERVICE_NAME} \
            --image=${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA} \
            --region=${_REGION} \
            --platform=managed \
            --allow-unauthenticated \
            --service-account=${_SERVICE_ACCOUNT} \
            --min-instances=${_MIN_INSTANCES} \
            --max-instances=${_MAX_INSTANCES} \
            --cpu=${_CPU} \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --concurrency=80 \
            --no-traffic \
            --tag=candidate \
            --set-env-vars=PROJECT_ID=${_PROJECT_ID},LOCATION_ID=us-central1,MODEL_ID=gemini-2.5-flash,DATASTORE_ID=kbdcomparison_1753071399773,DATASTORE_LOCATION=global,SYSTEM_PROMPT_PATH=prompt/prompt.txt,SPANNER_INSTANCE_ID=cheomkdbspanner,SPANNER_DATABASE_ID=kdbspanner,SPANNER_TABLE_NAME=Triple,USE_SECRET_MANAGER=True
        else
          echo "ğŸ†• ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ìƒì„± - ì§ì ‘ ë°°í¬"
          
          # ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ì¸ ê²½ìš°: ê¸°ë³¸ ë°°í¬ í›„ íƒœê·¸ ì¶”ê°€
          gcloud run deploy ${_SERVICE_NAME} \
            --image=${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA} \
            --region=${_REGION} \
            --platform=managed \
            --allow-unauthenticated \
            --service-account=${_SERVICE_ACCOUNT} \
            --min-instances=${_MIN_INSTANCES} \
            --max-instances=${_MAX_INSTANCES} \
            --cpu=${_CPU} \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --concurrency=80 \
            --set-env-vars=PROJECT_ID=${_PROJECT_ID},LOCATION_ID=us-central1,MODEL_ID=gemini-2.5-flash,DATASTORE_ID=kbdcomparison_1753071399773,DATASTORE_LOCATION=global,SYSTEM_PROMPT_PATH=prompt/prompt.txt,SPANNER_INSTANCE_ID=cheomkdbspanner,SPANNER_DATABASE_ID=kdbspanner,SPANNER_TABLE_NAME=Triple,USE_SECRET_MANAGER=True
          
          echo "ğŸ·ï¸ candidate íƒœê·¸ ì¶”ê°€ ì¤‘..."
          # ë°°í¬ í›„ í˜„ì¬ ë¦¬ë¹„ì „ì— candidate íƒœê·¸ ì¶”ê°€
          LATEST_REVISION=$(gcloud run services describe ${_SERVICE_NAME} --region=${_REGION} --format="value(status.latestReadyRevisionName)")
          gcloud run services update-traffic ${_SERVICE_NAME} \
            --region=${_REGION} \
            --set-tags candidate=$$LATEST_REVISION
        fi
        
        echo "âœ… ë°°í¬ ì™„ë£Œ!"
    id: 'deploy-candidate'
    waitFor: ['security-scan']

  # 6. í—¬ìŠ¤ ì²´í¬ ë° ê²€ì¦
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    
    args:
      - '-c'
      - |
        echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
        
        # í›„ë³´ ë²„ì „ URL ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ë°©ì‹)
        HEALTH_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="value(status.traffic[?tag='candidate'].url)")
        
        # íƒœê·¸ URLì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„œë¹„ìŠ¤ URL ì‚¬ìš©
        if [ -z "$$HEALTH_URL" ]; then
          echo "âš ï¸ candidate íƒœê·¸ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„œë¹„ìŠ¤ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          HEALTH_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
            --region=${_REGION} \
            --format="value(status.url)")
        fi
        
        if [ -z "$$HEALTH_URL" ]; then
          echo "âŒ ì„œë¹„ìŠ¤ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "í—¬ìŠ¤ ì²´í¬ URL: $$HEALTH_URL"
        
        # í—¬ìŠ¤ ì²´í¬ (ìµœëŒ€ 5íšŒ ì¬ì‹œë„)
        for i in {1..5}; do
          echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $$i/5..."
          
          if curl -f -s --max-time 30 "$$HEALTH_URL/api/health" > /dev/null; then
            echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
            
            # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸
            echo "ğŸ§ª API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
            RESPONSE=$$(curl -s --max-time 60 -X POST "$$HEALTH_URL/api/generate" \
              -F "userPrompt=í…ŒìŠ¤íŠ¸" \
              -F "conversationHistory=[]")
            
            if echo "$$RESPONSE" | grep -q "vertex_answer"; then
              echo "âœ… API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
              echo "URL=$$HEALTH_URL" > /workspace/candidate_url.txt
              exit 0
            else
              echo "âš ï¸ API ì‘ë‹µì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤: $$RESPONSE"
            fi
          else
            echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $$i/5)"
          fi
          
          if [ $$i -lt 5 ]; then
            echo "30ì´ˆ í›„ ì¬ì‹œë„..."
            sleep 30
          fi
        done
        
        echo "âŒ í—¬ìŠ¤ ì²´í¬ ìµœì¢… ì‹¤íŒ¨"
        exit 1
    id: 'health-check'
    waitFor: ['deploy-candidate']

  # 7. íŠ¸ë˜í”½ ì „í™˜ (Blue-Green ë°°í¬ ì™„ë£Œ)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ í”„ë¡œë•ì…˜ íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘..."
        
        # ëª¨ë“  íŠ¸ë˜í”½ì„ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜
        gcloud run services update-traffic ${_SERVICE_NAME} \
          --to-tags=candidate=100 \
          --region=${_REGION}
        
        echo "âœ… íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
        
        # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        echo "ì„œë¹„ìŠ¤ URL: https://${_SERVICE_NAME}-580360941782.${_REGION}.run.app"
        echo "ì»¤ë°‹ SHA: ${SHORT_SHA}"
        echo "ë°°í¬ ì‹œê°„: $(date)"
    id: 'traffic-switch'
    waitFor: ['health-check']

  # 8. ì´ì „ ë²„ì „ ì •ë¦¬ (ì„ íƒì‚¬í•­)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§¹ ì´ì „ ë²„ì „ ì •ë¦¬ ì¤‘..."
        
        # íƒœê·¸ ì œê±° (candidate íƒœê·¸ë¥¼ ì œê±°í•˜ì—¬ ì •ë¦¬)
        gcloud run services update-traffic ${_SERVICE_NAME} \
          --remove-tags=candidate \
          --region=${_REGION} || echo "âš ï¸ íƒœê·¸ ì œê±° ì‹¤íŒ¨ (ë¬´ì‹œ)"
        
        # ì˜¤ë˜ëœ ë¦¬ë¹„ì „ ì •ë¦¬ (ìµœê·¼ 5ê°œë§Œ ìœ ì§€)
        gcloud run revisions list \
          --service=${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="value(metadata.name)" \
          --limit=100 \
          | tail -n +6 \
          | xargs -I {} gcloud run revisions delete {} \
            --region=${_REGION} \
            --quiet || echo "âš ï¸ ì´ì „ ë¦¬ë¹„ì „ ì •ë¦¬ ì‹¤íŒ¨ (ë¬´ì‹œ)"
        
        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
    id: 'cleanup'
    waitFor: ['traffic-switch']

# ë¹Œë“œ ì˜µì…˜
options:
  # ë¹Œë“œ ë¡œê·¸ë¥¼ Cloud Loggingì—ë§Œ ì €ì¥
  logging: CLOUD_LOGGING_ONLY
  
  # ë¹Œë“œ ë¨¸ì‹  ìŠ¤í™ (ë” ë¹ ë¥¸ ë¹Œë“œë¥¼ ìœ„í•´)
  machineType: 'E2_HIGHCPU_8'
  
# ì„œë¹„ìŠ¤ ê³„ì • (í•„ìš”í•œ ê¶Œí•œ: Cloud Run Admin, Artifact Registry Writer, Security Scanner)
serviceAccount: 'projects/${_PROJECT_ID}/serviceAccounts/${_SERVICE_ACCOUNT}'

# ì´ë¯¸ì§€ ì €ì¥ì†Œì—ì„œ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ìë™ ì‚­ì œ (ì„ íƒì‚¬í•­)
images:
  - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'