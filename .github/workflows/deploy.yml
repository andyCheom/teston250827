# GitHub Actions - GraphRAG ë°±ì—”ë“œ API Cloud Run ë°°í¬
name: Deploy Backend to Cloud Run

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ
  push:
    branches:
      - main
      - develop
    paths:
      - 'main.py'
      - 'modules/**'
      - 'prompt/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
      - '.github/workflows/deploy.yml'
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# í™˜ê²½ ë³€ìˆ˜ (ë™ì ìœ¼ë¡œ ë¡œë“œë¨)
env:
  NODE_VERSION: '18'

jobs:
  # ë¹Œë“œ ë° ë°°í¬
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    # ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read
      id-token: write
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ì •ë³´ í¬í•¨)
      
      # 2. í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
      - name: Load environment variables from .env
        run: |
          if [ -f .env ]; then
            echo "ğŸ“„ .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì¤‘..."
            
            # .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ (ì£¼ì„ê³¼ ë¹ˆ ì¤„ ì œì™¸)
            export $(grep -v '^#' .env | grep -v '^$' | xargs)
            
            # GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            echo "PROJECT_ID=${PROJECT_ID}" >> $GITHUB_ENV
            echo "REGION=${LOCATION_ID}" >> $GITHUB_ENV
            echo "SERVICE_NAME=${PROJECT_ID}-graphrag-api" >> $GITHUB_ENV
            echo "FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}" >> $GITHUB_ENV
            echo "SERVICE_ACCOUNT_EMAIL=${SERVICE_ACCOUNT_EMAIL}" >> $GITHUB_ENV
            echo "DISCOVERY_ENGINE_ID=${DISCOVERY_ENGINE_ID}" >> $GITHUB_ENV
            echo "DATASTORE_ID=${DATASTORE_ID}" >> $GITHUB_ENV
            
            echo "âœ… í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ:"
            echo "  PROJECT_ID: ${PROJECT_ID}"
            echo "  REGION: ${LOCATION_ID}"
            echo "  SERVICE_NAME: ${PROJECT_ID}-graphrag-api"
          else
            echo "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
      
      # 3. Google Cloud ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      # 4. Cloud SDK ì„¤ì •
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      # 5. Artifact Registry ì¸ì¦
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      
      # 6. í™˜ê²½ë³„ ë³€ìˆ˜ ì„¤ì •
      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
          fi
          
          # ì§§ì€ ì»¤ë°‹ SHA ìƒì„±
          echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          
          echo "âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ: ${{ github.ref_name }} â†’ ${ENVIRONMENT:-staging}"
      
          
      # 7. ì¢…ì†ì„± ìºì‹œ
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      # 8. Cloud Build ì‹¤í–‰
      - name: Run Cloud Build
        run: |
          gcloud builds submit             --config=cloudbuild.yaml             --substitutions=_SERVICE_NAME=${{ env.SERVICE_NAME }},SHORT_SHA=${{ env.SHORT_SHA }}             --timeout=1200s
      
      # 9. ë°°í¬ ê²°ê³¼ í™•ì¸
      - name: Verify deployment
        run: |
          echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ì„œë¹„ìŠ¤ URL ê°€ì ¸ì˜¤ê¸°
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="value(status.url)")
          
          echo "ì„œë¹„ìŠ¤ URL: $SERVICE_URL"
          
          # í—¬ìŠ¤ ì²´í¬ (ë¹ ë¥¸ ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬ ë¨¼ì €)
          for i in {1..10}; do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/10..."
            if timeout 15 curl -f -s --connect-timeout 5 --max-time 10 "$SERVICE_URL/api/health" > /dev/null; then
              echo "âœ… ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
              
              # ìƒì„¸ í—¬ìŠ¤ ì²´í¬ë„ ìˆ˜í–‰
              echo "ğŸ” ìƒì„¸ í—¬ìŠ¤ ì²´í¬ ì§„í–‰..."
              if timeout 20 curl -f -s --connect-timeout 5 --max-time 15 "$SERVICE_URL/api/health/detailed" > /dev/null; then
                echo "âœ… ìƒì„¸ í—¬ìŠ¤ ì²´í¬ë„ ì„±ê³µ!"
              else
                echo "âš ï¸ ìƒì„¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ê¸°ë³¸ í—¬ìŠ¤ëŠ” ì •ìƒ)"
              fi
              
              echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $i -lt 10 ]; then
              echo "15ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 15
            fi
          done
          
          echo "âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨"
          exit 1
      
      # 10. Google Chat ì•Œë¦¼ (ì„±ê³µ)
      - name: Notify success to Google Chat
        if: success()
        run: |
          WEBHOOK_URL="${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
          
          if [ -n "$WEBHOOK_URL" ]; then
            echo "ğŸ“¢ Google Chatìœ¼ë¡œ ë°°í¬ ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
            
            # ì„œë¹„ìŠ¤ URL ê°€ì ¸ì˜¤ê¸°
            SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --format="value(status.url)" 2>/dev/null || echo "URL ì¡°íšŒ ì‹¤íŒ¨")
            
            # Google Chat ë©”ì‹œì§€ í˜ì´ë¡œë“œ ìƒì„±
            PAYLOAD=$(cat <<EOF
            {
              "text": "ğŸ‰ *GraphRAG API ë°°í¬ ì„±ê³µ!*",
              "cards": [{
                "header": {
                  "title": "GraphRAG ë°±ì—”ë“œ ë°°í¬ ì•Œë¦¼",
                  "subtitle": "Cloud Run ë°°í¬ ì™„ë£Œ"
                },
                "sections": [{
                  "widgets": [
                    {
                      "keyValue": {
                        "topLabel": "ë°°í¬ ìƒíƒœ",
                        "content": "âœ… ì„±ê³µ",
                        "contentMultiline": false,
                        "icon": "CHECK_CIRCLE"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "í™˜ê²½",
                        "content": "${{ env.ENVIRONMENT }}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ë¸Œëœì¹˜",
                        "content": "${{ github.ref_name }}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ì»¤ë°‹",
                        "content": "${{ env.SHORT_SHA }}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ì„œë¹„ìŠ¤ URL",
                        "content": "${SERVICE_URL}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ì„œë¹„ìŠ¤ëª…",
                        "content": "${{ env.SERVICE_NAME }}",
                        "contentMultiline": false
                      }
                    }
                  ]
                }],
                "cardActions": [
                  {
                    "actionLabel": "API í—¬ìŠ¤ ì²´í¬",
                    "onClick": {
                      "openLink": {
                        "url": "${SERVICE_URL}/api/health"
                      }
                    }
                  },
                  {
                    "actionLabel": "ì›Œí¬í”Œë¡œìš° ë³´ê¸°",
                    "onClick": {
                      "openLink": {
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    }
                  }
                ]
              }]
            }
          EOF
            )
            
            # Google Chatìœ¼ë¡œ ì „ì†¡
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$WEBHOOK_URL"
            
            if [ $? -eq 0 ]; then
              echo "âœ… Google Chat ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
            else
              echo "âŒ Google Chat ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ GOOGLE_CHAT_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi
      
      # 11. Google Chat ì•Œë¦¼ (ì‹¤íŒ¨)
      - name: Notify failure to Google Chat
        if: failure()
        run: |
          WEBHOOK_URL="${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
          
          if [ -n "$WEBHOOK_URL" ]; then
            echo "ğŸ“¢ Google Chatìœ¼ë¡œ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
            
            # Google Chat ë©”ì‹œì§€ í˜ì´ë¡œë“œ ìƒì„±
            PAYLOAD=$(cat <<EOF
            {
              "text": "âŒ *GraphRAG API ë°°í¬ ì‹¤íŒ¨*",
              "cards": [{
                "header": {
                  "title": "GraphRAG ë°±ì—”ë“œ ë°°í¬ ì•Œë¦¼",
                  "subtitle": "Cloud Run ë°°í¬ ì‹¤íŒ¨"
                },
                "sections": [{
                  "widgets": [
                    {
                      "keyValue": {
                        "topLabel": "ë°°í¬ ìƒíƒœ",
                        "content": "âŒ ì‹¤íŒ¨",
                        "contentMultiline": false,
                        "icon": "ERROR"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "í™˜ê²½",
                        "content": "${{ env.ENVIRONMENT }}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ë¸Œëœì¹˜",
                        "content": "${{ github.ref_name }}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ì»¤ë°‹",
                        "content": "${{ env.SHORT_SHA }}",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ì„œë¹„ìŠ¤ëª…",
                        "content": "${{ env.SERVICE_NAME }}",
                        "contentMultiline": false
                      }
                    }
                  ]
                }],
                "cardActions": [{
                  "actionLabel": "ë¡œê·¸ ë³´ê¸°",
                  "onClick": {
                    "openLink": {
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  }
                }]
              }]
            }
          EOF
            )
            
            # Google Chatìœ¼ë¡œ ì „ì†¡
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$WEBHOOK_URL"
            
            if [ $? -eq 0 ]; then
              echo "âœ… Google Chat ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
            else
              echo "âŒ Google Chat ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ GOOGLE_CHAT_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi

  # # ë³´ì•ˆ ìŠ¤ìº” (ë³„ë„ ì¡)
  # security-scan:
  #   name: Security Scan
  #   runs-on: ubuntu-latest
  #   needs: deploy
  #   if: always() && (needs.deploy.result == 'success')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
      
  #     # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (deploy jobê³¼ ë™ì¼)
  #     - name: Set environment variables
  #       run: |
  #         if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
  #           echo "ENVIRONMENT=production" >> $GITHUB_ENV
  #           echo "SERVICE_NAME=graphrag-api" >> $GITHUB_ENV
  #         else
  #           echo "ENVIRONMENT=staging" >> $GITHUB_ENV
  #           echo "SERVICE_NAME=testing0724" >> $GITHUB_ENV
  #         fi
          
  #         # ì§§ì€ ì»¤ë°‹ SHA ìƒì„±
  #         echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
      
  #     - name: Run Trivy vulnerability scanner
  #       uses: aquasecurity/trivy-action@master
  #       with:
  #         image-ref: 'asia-northeast3-docker.pkg.dev/${{ env.PROJECT_ID }}/trialanderror0724/${{ env.SERVICE_NAME }}:${{ env.SHORT_SHA }}'
  #         format: 'sarif'
  #         output: 'trivy-results.sarif'
  #       continue-on-error: true
      
  #     - name: Upload Trivy scan results to GitHub Security tab
  #       uses: github/codeql-action/upload-sarif@v3
  #       if: always() && hashFiles('trivy-results.sarif') != ''
  #       with:
  #         sarif_file: 'trivy-results.sarif'