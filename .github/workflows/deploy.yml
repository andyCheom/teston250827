# GitHub Actions - GraphRAG ì±—ë´‡ API ì§€ì†ì  ë°°í¬
name: Deploy to Cloud Run

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# í™˜ê²½ ë³€ìˆ˜
env:
  PROJECT_ID: cheom-kdb-test1
  REGION: asia-northeast3
  SERVICE_NAME: testing0724

jobs:
  # ë¹Œë“œ ë° ë°°í¬
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    # ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read
      id-token: write
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ì •ë³´ í¬í•¨)
      
      # 2. Google Cloud ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      # 3. Cloud SDK ì„¤ì •
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      # 4. Artifact Registry ì¸ì¦
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev
      
      # 5. í™˜ê²½ë³„ ë³€ìˆ˜ ì„¤ì •
      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "SERVICE_NAME=graphrag-api" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "SERVICE_NAME=testing0724" >> $GITHUB_ENV
          fi
          
          # ì§§ì€ ì»¤ë°‹ SHA ìƒì„±
          echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
      
      # 6. ì¢…ì†ì„± ìºì‹œ
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      # 7. Cloud Build ì‹¤í–‰
      - name: Run Cloud Build
        run: |
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_SERVICE_NAME=${{ env.SERVICE_NAME }},SHORT_SHA=${{ env.SHORT_SHA }},BRANCH_NAME=${{ github.ref_name }} \
            --timeout=1200s
      
      # 8. ë°°í¬ ê²°ê³¼ í™•ì¸
      - name: Verify deployment
        run: |
          echo "ðŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ì„œë¹„ìŠ¤ URL ê°€ì ¸ì˜¤ê¸°
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="value(status.url)")
          
          echo "ì„œë¹„ìŠ¤ URL: $SERVICE_URL"
          
          # í—¬ìŠ¤ ì²´í¬
          for i in {1..5}; do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/5..."
            if curl -f -s --max-time 30 "$SERVICE_URL/api/health" > /dev/null; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $i -lt 5 ]; then
              echo "30ì´ˆ í›„ ìž¬ì‹œë„..."
              sleep 30
            fi
          done
          
          echo "âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨"
          exit 1
      
      # 9. Slack ì•Œë¦¼ (ì„±ê³µ)
      - name: Notify success to Slack
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ðŸŽ‰ GraphRAG API ë°°í¬ ì„±ê³µ!
            â€¢ í™˜ê²½: ${{ env.ENVIRONMENT }}
            â€¢ ë¸Œëžœì¹˜: ${{ github.ref_name }}
            â€¢ ì»¤ë°‹: ${{ env.SHORT_SHA }}
            â€¢ ì„œë¹„ìŠ¤: ${{ steps.verify-deployment.outputs.SERVICE_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      # 10. Slack ì•Œë¦¼ (ì‹¤íŒ¨)
      - name: Notify failure to Slack
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            âŒ GraphRAG API ë°°í¬ ì‹¤íŒ¨
            â€¢ í™˜ê²½: ${{ env.ENVIRONMENT }}
            â€¢ ë¸Œëžœì¹˜: ${{ github.ref_name }}
            â€¢ ì»¤ë°‹: ${{ env.SHORT_SHA }}
            â€¢ ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ë³´ì•ˆ ìŠ¤ìº” (ë³„ë„ ìž¡)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && (needs.deploy.result == 'success')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (deploy jobê³¼ ë™ì¼)
      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "SERVICE_NAME=graphrag-api" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "SERVICE_NAME=testing0724" >> $GITHUB_ENV
          fi
          
          # ì§§ì€ ì»¤ë°‹ SHA ìƒì„±
          echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'asia-northeast3-docker.pkg.dev/${{ env.PROJECT_ID }}/trialanderror0724/${{ env.SERVICE_NAME }}:${{ env.SHORT_SHA }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'