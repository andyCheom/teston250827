# Firebase Hosting CI/CD Pipeline
name: Firebase Hosting Deploy

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # Pull Requestì— ëŒ€í•œ í”„ë¦¬ë·° ë°°í¬
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'public/**'
      - 'firebase.json'
      - '.github/workflows/firebase-hosting.yml'
  
  # ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ë°°í¬
  push:
    branches:
      - main      # í”„ë¡œë•ì…˜ ë°°í¬
      - develop   # ìŠ¤í…Œì´ì§• ë°°í¬
    paths:
      - 'public/**'
      - 'firebase.json'
      - '.github/workflows/firebase-hosting.yml'
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# í™˜ê²½ ë³€ìˆ˜ (ë™ì ìœ¼ë¡œ ë¡œë“œë¨)
env:
  NODE_VERSION: '18'

jobs:
  # ë¹Œë“œ ë° ê²€ì¦
  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
      - name: Load environment variables from .env
        run: |
          if [ -f .env ]; then
            echo "ğŸ“„ .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì¤‘..."
            
            # .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ (ì£¼ì„ê³¼ ë¹ˆ ì¤„ ì œì™¸)
            export $(grep -v '^#' .env | grep -v '^$' | xargs)
            
            # GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            echo "PROJECT_ID=${PROJECT_ID}" >> $GITHUB_ENV
            echo "FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}" >> $GITHUB_ENV
            echo "SERVICE_ACCOUNT_EMAIL=${SERVICE_ACCOUNT_EMAIL}" >> $GITHUB_ENV
            
            echo "âœ… Firebase í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ:"
            echo "  FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}"
          else
            echo "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
      
      # 3. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # 4. ì˜ì¡´ì„± ì„¤ì¹˜ (public ë””ë ‰í† ë¦¬ì—ì„œ)
      - name: Install dependencies
        run: |
          if [ -f "public/package.json" ]; then
            cd public
            npm ci
          else
            echo "âš ï¸ public/package.json not found, skipping npm install"
          fi
      
      # 5. í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build project
        run: |
          if [ -f "public/package.json" ]; then
            cd public
            npm run build || echo "âš ï¸ No build script found"
          else
            echo "âœ… Static files ready for deployment"
          fi
      
      # 6. Firebase ì„¤ì • ê²€ì¦
      - name: Validate Firebase configuration
        run: |
          echo "ğŸ” Firebase ì„¤ì • ê²€ì¦ ì¤‘..."
          
          # firebase.json ì¡´ì¬ í™•ì¸
          if [ ! -f "firebase.json" ]; then
            echo "âŒ firebase.jsonì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # public ë””ë ‰í† ë¦¬ í™•ì¸
          if [ ! -d "public" ]; then
            echo "âŒ public ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # index.html í™•ì¸
          if [ ! -f "public/index.html" ]; then
            echo "âŒ public/index.htmlì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… Firebase ì„¤ì • ê²€ì¦ ì™„ë£Œ"
      
      # 7. ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firebase-build-${{ github.sha }}
          path: public/
          retention-days: 1

  # Pull Requestìš© í”„ë¦¬ë·° ë°°í¬
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Load environment variables from .env
        run: |
          if [ -f .env ]; then
            export $(grep -v '^#' .env | grep -v '^$' | xargs)
            echo "FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}" >> $GITHUB_ENV
          fi
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: firebase-build-${{ github.sha }}
          path: public/
      
      - name: Deploy to Firebase Hosting Preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SA_KEY }}
          projectId: ${{ env.FIREBASE_PROJECT_ID }}
          channelId: preview-${{ github.event.number }}
          expires: 7d
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  # ìŠ¤í…Œì´ì§• ë°°í¬ (develop ë¸Œëœì¹˜)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    environment:
      name: staging
      url: https://staging--${{ env.FIREBASE_PROJECT_ID }}.web.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Load environment variables from .env
        run: |
          if [ -f .env ]; then
            export $(grep -v '^#' .env | grep -v '^$' | xargs)
            echo "FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}" >> $GITHUB_ENV
          fi
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: firebase-build-${{ github.sha }}
          path: public/
      
      # ìŠ¤í…Œì´ì§• í™˜ê²½ ì„¤ì • ì—…ë°ì´íŠ¸
      - name: Update Firebase config for staging
        run: |
          echo "ğŸ”§ ìŠ¤í…Œì´ì§• í™˜ê²½ ì„¤ì • ì ìš© ì¤‘..."
          
          # firebase.jsonì—ì„œ ì„œë¹„ìŠ¤ IDë¥¼ í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì„œë¹„ìŠ¤ë¡œ ë³€ê²½
          STAGING_SERVICE_ID="${PROJECT_ID}-graphrag-api"
          sed -i "s/__BACKEND_SERVICE_ID__/${STAGING_SERVICE_ID}/" firebase.json
          
          echo "âœ… ìŠ¤í…Œì´ì§• ì„¤ì • ì™„ë£Œ: ${STAGING_SERVICE_ID}"
      
      - name: Deploy to Firebase Hosting Staging
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SA_KEY }}
          projectId: ${{ env.FIREBASE_PROJECT_ID }}
          channelId: staging
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
      
      # ìŠ¤í…Œì´ì§• ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬
      - name: Health check staging
        run: |
          echo "ğŸ¥ ìŠ¤í…Œì´ì§• í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          STAGING_URL="https://staging--${{ env.FIREBASE_PROJECT_ID }}.web.app"
          
          for i in {1..5}; do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/5..."
            if curl -f -s --max-time 30 "$STAGING_URL" > /dev/null; then
              echo "âœ… ìŠ¤í…Œì´ì§• ë°°í¬ ì„±ê³µ!"
              exit 0
            fi
            
            if [ $i -lt 5 ]; then
              echo "30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
            fi
          done
          
          echo "âŒ ìŠ¤í…Œì´ì§• í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
          exit 1

  # í”„ë¡œë•ì…˜ ë°°í¬ (main ë¸Œëœì¹˜)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://${{ env.FIREBASE_PROJECT_ID }}.web.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Load environment variables from .env
        run: |
          if [ -f .env ]; then
            export $(grep -v '^#' .env | grep -v '^$' | xargs)
            echo "FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}" >> $GITHUB_ENV
            echo "PROJECT_ID=${PROJECT_ID}" >> $GITHUB_ENV
          fi
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: firebase-build-${{ github.sha }}
          path: public/
      
      # í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì • ì—…ë°ì´íŠ¸
      - name: Update Firebase config for production
        run: |
          echo "ğŸ”§ í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì • ì ìš© ì¤‘..."
          
          # firebase.jsonì—ì„œ ì„œë¹„ìŠ¤ IDë¥¼ í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì„œë¹„ìŠ¤ë¡œ ë³€ê²½
          PRODUCTION_SERVICE_ID="${PROJECT_ID}-graphrag-api"
          sed -i "s/\"serviceId\": \"[^\"]*\"/\"serviceId\": \"${PRODUCTION_SERVICE_ID}\"/" firebase.json
          
          echo "âœ… í”„ë¡œë•ì…˜ ì„¤ì • ì™„ë£Œ: ${PRODUCTION_SERVICE_ID}"
      
      - name: Deploy to Firebase Hosting Production
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SA_KEY }}
          projectId: ${{ env.FIREBASE_PROJECT_ID }}
          channelId: live
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
      
      # í”„ë¡œë•ì…˜ ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬
      - name: Health check production
        run: |
          echo "ğŸ¥ í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          PROD_URL="https://${{ env.FIREBASE_PROJECT_ID }}.web.app"
          
          for i in {1..10}; do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/10..."
            if curl -f -s --max-time 30 "$PROD_URL" > /dev/null; then
              echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!"
              echo "PROD_URL=$PROD_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $i -lt 10 ]; then
              echo "30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
            fi
          done
          
          echo "âŒ í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
          exit 1
        id: health-check
      

  # ë°°í¬ ì•Œë¦¼
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result != 'skipped' || needs.deploy-production.result != 'skipped')
    
    steps:
      - name: Determine deployment result
        run: |
          if [[ "${{ needs.deploy-staging.result }}" == "success" || "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "DEPLOYMENT_STATUS=success" >> $GITHUB_ENV
            echo "DEPLOYMENT_EMOJI=ğŸ‰" >> $GITHUB_ENV
          else
            echo "DEPLOYMENT_STATUS=failure" >> $GITHUB_ENV
            echo "DEPLOYMENT_EMOJI=âŒ" >> $GITHUB_ENV
          fi
          
          # í™˜ê²½ ê²°ì •
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "DEPLOYMENT_ENV=Production" >> $GITHUB_ENV
            echo "DEPLOYMENT_URL=https://${{ env.FIREBASE_PROJECT_ID }}.web.app" >> $GITHUB_ENV
          else
            echo "DEPLOYMENT_ENV=Staging" >> $GITHUB_ENV
            echo "DEPLOYMENT_URL=https://staging--${{ env.FIREBASE_PROJECT_ID }}.web.app" >> $GITHUB_ENV
          fi
      
      - name: Send Google Chat notification
        run: |
          # Google Chat ì›¹í›…ìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡
          WEBHOOK_URL="${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
          
          if [ -n "$WEBHOOK_URL" ]; then
            echo "ğŸ“¢ Google Chatìœ¼ë¡œ ë°°í¬ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
            
            # ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
            if [ "${{ env.DEPLOYMENT_STATUS }}" == "success" ]; then
              CARD_COLOR="#00FF00"  # ì´ˆë¡ìƒ‰
              STATUS_TEXT="ì„±ê³µ"
            else
              CARD_COLOR="#FF0000"  # ë¹¨ê°„ìƒ‰
              STATUS_TEXT="ì‹¤íŒ¨"
            fi
            
            # Google Chat ë©”ì‹œì§€ JSON íŒŒì¼ ìƒì„±
            cat > /tmp/firebase_payload.json << 'EOL'
            {
              "text": "Firebase Hosting ë°°í¬ STATUS_PLACEHOLDER",
              "cards": [{
                "header": {
                  "title": "GraphRAG Firebase ë°°í¬ ì•Œë¦¼",
                  "subtitle": "í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ìƒíƒœ"
                },
                "sections": [{
                  "widgets": [
                    {
                      "keyValue": {
                        "topLabel": "ë°°í¬ ìƒíƒœ", 
                        "content": "STATUS_PLACEHOLDER",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "í™˜ê²½",
                        "content": "ENV_PLACEHOLDER",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ë¸Œëœì¹˜",
                        "content": "BRANCH_PLACEHOLDER", 
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ì»¤ë°‹",
                        "content": "COMMIT_PLACEHOLDER",
                        "contentMultiline": false
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "ë°°í¬ URL",
                        "content": "URL_PLACEHOLDER",
                        "contentMultiline": false
                      }
                    }
                  ]
                }]
              }]
            }
          EOL
            
            # í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
            sed -i "s/STATUS_PLACEHOLDER/${STATUS_TEXT}/g" /tmp/firebase_payload.json
            sed -i "s/ENV_PLACEHOLDER/${{ env.DEPLOYMENT_ENV }}/g" /tmp/firebase_payload.json  
            sed -i "s/BRANCH_PLACEHOLDER/${{ github.ref_name }}/g" /tmp/firebase_payload.json
            sed -i "s/COMMIT_PLACEHOLDER/${{ github.sha }}/g" /tmp/firebase_payload.json
            sed -i "s|URL_PLACEHOLDER|${{ env.DEPLOYMENT_URL }}|g" /tmp/firebase_payload.json
            
            # ì•„ì´ì½˜ì€ ì œê±°ë¨ (Google Chat API í˜¸í™˜ì„± ë¬¸ì œ)
            
            # Google Chatìœ¼ë¡œ ì „ì†¡
            curl -X POST \
              -H "Content-Type: application/json" \
              -d @/tmp/firebase_payload.json \
              "$WEBHOOK_URL"
            
            if [ $? -eq 0 ]; then
              echo "âœ… Google Chat ì•Œë¦¼ ì „ì†¡ ì„±ê³µ"
            else
              echo "âŒ Google Chat ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ GOOGLE_CHAT_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi
        if: env.DEPLOYMENT_STATUS != ''
